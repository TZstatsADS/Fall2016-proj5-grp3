---
title: "Data Cleaning"
author: "Chenxi Huang (ch3129)"
date: "December 2, 2016"
output: html_document
---

```{r}
# set the working directory
setwd("C:/Users/celia/Desktop/Project 5")
set.seed(2016)
```

```{r}
# Load libraries
library(data.table)
library(dplyr)
library(base)
library(ggplot2)
#library(tidyr)
#library(lubridate)

```

```{r}
# load data
load("./san.train.samp(ori feat(smaller)).Rdata")
san.train.samp
dim(san.train.samp) # 1426529 by 48
# total features
names(san.train.samp)[1:24]
# total products
names(san.train.samp)[25:48]
```

```{r}
##################### Data Cleaning #####################

##### Time: Convert String to Time Format for calculation later ############
t1=Sys.time()
san.train.samp$fecha_dato=as.POSIXct(strptime(san.train.samp$fecha_dato,format="%Y-%m-%d"))
san.train.samp$fecha_alta=as.POSIXct(strptime(san.train.samp$fecha_alta,format="%Y-%m-%d"))
t2=Sys.time()
t2-t1
# check the dates in standard Year-Month-Day format
unique(san.train.samp$fecha_dato)
class(san.train.samp$fecha_dato)

# Are buying new product associated with Month?
# Add one more column of feature to original 
san.train.samp$month=month(san.train.samp$fecha_dato)
unique(san.train.samp$month)
table(san.train.samp$month)
plot(table(san.train.samp$month),xlab="month",ylab="frequency",main="Month Vs Frequency in Sampled Data")
# save plot
dev.copy(png,'month.png')
dev.off()
```

```{r}
############## Feature Creation ############
############## New Feature 1: Month #############
# so we have a new feature of month now 
names(san.train.samp)
san.train.samp$month
```

```{r}
############## Missing Values ################
# which columns have missing values?
ind.mis=which(sapply(san.train.samp,function(x) any(is.na(x))) == TRUE)
ind.mis
mis.name=names(san.train.samp)[ind.mis]
mis.name
#"age","fecha_alta","ind_nuevo","antiguedad","indrel","tipodom","cod_prov","ind_actividad_cliente","renta","ind_nomina_ult1","ind_nom_pens_ult1"   
length(ind.mis.name) 
# 11 columns have missing values
```

```{r}
########### 1. Missing Values: Age ##############
length(which(is.na(san.train.samp$age) == T))
# plot to see the distribution
age.table1=table(san.train.samp$age)
age.table1
plot(age.table1,main="Age Distribution", xlab="Age",ylab="Frequency")
abline(h=1146,col="red")
# save plot
dev.copy(png,'age(ori).png')
dev.off()

# we can see that it peaked around age 19-24 and middle-aged people
# remove people with almost impossible ages
# age < 18 not many have bank accounts
# age > 90 too old 

# fill in the NA with mean
san.train.samp$age[is.na(san.train.samp$age)]=mean(san.train.samp$age[(san.train.samp$age >= 18)&(san.train.samp$age <=90)],na.rm=TRUE)
# mean is  40.05889
# round them up
san.train.samp$age=round(san.train.samp$age)
age.table2=table(san.train.samp$age)
age.table2
summary(is.na(san.train.samp$age))   #all FALSE, no NA anymore
# done with age
```


```{r}
############ 2. Missing Values: fecha_alta ############
# The date in which the customer became as the first holder of a contract in the bank
# assign Na to median
table(san.train.samp$fecha_alta)
san.train.samp$fecha_alta[is.na(san.train.samp$fecha_alta)]=median(san.train.samp$fecha_alta,na.rm=TRUE)
sum(is.na(san.train.samp$fecha_alta)) #0
# done here
```


```{r}
############ 3. Missing Values: ind_nuevo (New customer Index) ############
# "ind_nuevo": New customer Index. 1 if the customer registered in the last 6 months.
sum(is.na(san.train.samp$ind_nuevo))
# 2816 NA

# let's see whether they are new customers by determining how many months of record they have been active
months.active=san.train.samp[is.na(san.train.samp$ind_nuevo),] %>%
                  group_by(ncodpers) %>%
                  summarise(months.active=n()) %>%
                  select(months.active)
max(months.active)
# 6 
# means they are all new customers
# assign 1 to NA
san.train.samp$ind_nuevo[is.na(san.train.samp$ind_nuevo)]=1 
sum(is.na(san.train.samp$ind_nuevo)) #0, no NA anymore
table(san.train.samp$ind_nuevo)
#     0 (1339068 ) and 1(87461 )
```


```{r}
############ 4. Missing Values: "antiguedad" ############
# Customer seniority (in months)
sum(is.na(san.train.samp$antiguedad))
# 2816
# same number as in the "ind_nuevo"
# probably the same people
summary(san.train.samp[is.na(san.train.samp$antiguedad),]%>%select(ind_nuevo))
# double check
# yes they are the same people


table(san.train.samp$antiguedad)
# check their registered number of months
cus.6month = c( 
             which(year(san.train.samp$fecha_alta) == 2015 & month(san.train.samp$fecha_alta)== 12),
             which(year(san.train.samp$fecha_alta) == 2016 & month(san.train.samp$fecha_alta)== 1),
             which(year(san.train.samp$fecha_alta) == 2016 & month(san.train.samp$fecha_alta)== 2),
             which(year(san.train.samp$fecha_alta) == 2016 & month(san.train.samp$fecha_alta)== 3),
             which(year(san.train.samp$fecha_alta) == 2016 & month(san.train.samp$fecha_alta)== 4),
             which(year(san.train.samp$fecha_alta) == 2016 & month(san.train.samp$fecha_alta) == 5))

length(cus.6month) #13137
# roughly the numbe of people who have registered under 6 months
san.train.samp$antiguedad[is.na(san.train.samp$antiguedad)]=min(san.train.samp$antiguedad,na.rm=TRUE)
sum(is.na(san.train.samp$antiguedad)) #0
# done here

```

```{r}
############################ 5. Missing Values: "indrel"########################
mis.name[5]
# "indrel"
# 1 (First/Primary), 99 (Primary customer during the month but not at the end of the month)
table(san.train.samp$indrel)
# fill with most common status
san.train.samp$indrel[is.na(san.train.samp$indrel)]=1
sum(is.na(san.train.samp$indrel)) #0
# done here
```


```{r}
############################ 6. Missing Values: "tipodom"########################
mis.name[6]
# "tipodom"
# Addres type. 1, primary address 
table(san.train.samp$tipodom)
# all=1,primary
# fill with most common status, which is only 1
sum(is.na(san.train.samp$tipodom)) 
# 2816, we've seen this number
# same group of the new customers
san.train.samp$tipodom[is.na(san.train.samp$tipodom)]=1
sum(is.na(san.train.samp$tipodom)) #0
# done here
```

```{r}
############################ 7. Missing Values: "cod_prov"########################
mis.name[7]
# cod_prov
# Province code (customer's address)
sum(is.na(san.train.samp$cod_prov)) #9805
cod_prov.ind=which(is.na(san.train.samp$cod_prov))

table(san.train.samp$cod_prov)  # balanced, no extreme cases
plot(table(san.train.samp$cod_prov))
# look at their province name
table(san.train.samp[is.na(san.train.samp$cod_prov),]$nomprov)
# same people
table(san.train.samp[is.na(san.train.samp$cod_prov),]$ncodpers)
san.train.samp[san.train.samp$ncodpers==208572,]

plot(table(san.train.samp$nomprov),xlab="province",ylab="frequency",main="Code Province Frequency")
# save plot
dev.copy(png,'cod_prov.png')
dev.off()

which.max(table(san.train.samp$cod_prov))
# 28
# see which province is this 
san.train.samp[san.train.samp$cod_prov==28,]$nomprov
# MADRID
which.max(table(san.train.samp$nomprov))
# MADRID 32
# significantly more than other cities
# assign these prov codes to MARID
san.train.samp$cod_prov[is.na(san.train.samp$cod_prov)]=which.max(table(san.train.samp$cod_prov))
sum(is.na(san.train.samp$cod_prov)) #0

san.train.samp$nomprov[which(san.train.samp$nomprov=="")]= "MADRID"
sum(san.train.samp$nomprov == "") #0

```

```{r}
############################ 8. Missing Values: 'ind_actividad_cliente"########################
mis.name[8]
# ind_actividad_cliente
# Activity index (1, active customer; 0, inactive customer)
sum(is.na(san.train.samp$ind_actividad_cliente))
#  2816
# same number, same group of people

table(san.train.samp$ind_actividad_cliente)
san.train.samp$ind_actividad_cliente[is.na(san.train.samp$ind_actividad_cliente)]=median(san.train.samp$ind_actividad_cliente,na.rm=TRUE)
sum(is.na(san.train.samp$ind_actividad_cliente)) #0
# done here
```


```{r}
############################ 9. Missing Values: "renta" ########################
mis.name[9]
# renta
# Gross income of the household

sum(is.na(san.train.samp$renta)) #290984
# a lot of values are missing
income.table=table(san.train.samp$renta)
plot(income.table)


# could it be related to regions?

# region vs median of income 
plot.med=san.train.samp %>%
  filter(!is.na(renta)) %>%
  group_by(nomprov) %>%
  summarise(income.med = median(renta)) %>%
  arrange(income.med) %>%
  mutate(city=factor(nomprov,levels=nomprov)) %>% 
  ggplot(aes(x=city,y=income.med)) + 
  geom_point(color="sky blue") + 
  guides(color=FALSE) + 
  xlab("City") +
  ylab("Median of Income") +  
  theme(axis.text.x=element_blank(), axis.ticks = element_blank()) + 
  geom_text(aes(x=city,y=income.med,label=city),angle=90,hjust=-0.5) +
  ggtitle("Regional Income Distribution (By Median)")
  
#region vs mean of income
plot.mean=san.train.samp %>%
  filter(!is.na(renta)) %>%
  group_by(nomprov) %>%
  summarise(income.mean = mean(renta)) %>%
  arrange(income.mean) %>%
  mutate(city=factor(nomprov,levels=nomprov)) %>% 
  ggplot(aes(x=city,y=income.mean)) + 
  geom_point(color="pink") + 
  guides(color=FALSE) + 
  xlab("City") +
  ylab("Mean of Income") +  
  theme(axis.text.x=element_blank(), axis.ticks = element_blank()) + 
  geom_text(aes(x=city,y=income.mean,label=city),angle=90,hjust=-0.5) +
  ggtitle("Regional Income Distribution (By Mean)")


plot.med
# save plot
dev.copy(png,'income by median.png', height=600, width=1000)
dev.off()

plot.mean
# save plot
dev.copy(png,'income by mean.png', height=600, width=1000)
dev.off()


# choose median because it doesnt count extreme values
# see levels
city.level=unique(san.train.samp$nomprov)
city.n=length(unique(san.train.samp$nomprov)) # 53
city.n


# looping to get city income median
city.income.med=vector()
for (i in 1:city.n) {
  this_city=city.level[i]
  this_city.mat=san.train.samp[san.train.samp$nomprov==this_city,]
  this_city.na=which(is.na(this_city.mat$renta))
  this_city.clean=this_city.mat[-this_city.na,]
  this_city.med=median(this_city.clean$renta)
  city.income.med[i] = this_city.med
}

city.income.med
city.income=cbind(city.level,city.income.med)
city.income
dim(city.income)

# assign NA values by cities
ind.income.na=which(is.na(san.train.samp$renta))
ind.income.na

# looping
#t1=Sys.time()
#for (j in 1:length(ind.income.na)){
 # city_ind=ind.income.na[j]
  #the_city=san.train.samp$nomprov[city_ind]
  #the_city_income.ind=which(city.income[,1]==the_city)
  #the_city_income=as.numeric(city.income[the_city_income.ind,2])
  # assign values to NA
  #san.train.samp$renta[city_ind]=the_city_income}

#t2=Sys.time()
#t2 - t1
# san.train.samp$renta[5] = 66541.89
# this method takes too long

t1=Sys.time()
for(j in 1:city.n){
city_ind=which(san.train.samp$nomprov==city.level[j])
na.ind=which(is.na(san.train.samp[city_ind,]$renta)== T)

# assign values
san.train.samp[city_ind,][na.ind,]$renta = as.numeric(city.income[j,2])

}
t2=Sys.time()
t2 - t1
# Time difference of 19.66282 secs

san.train.samp$renta
san.train.samp$renta[5]
sum(is.na(san.train.samp$renta)) #0
# done
```


```{r}
############################ 10. Missing Values: "ind_nomina_ult1" ########################
mis.name[10]
#"ind_nomina_ult1"
ind_nomina.mis=which(is.na(san.train.samp$ind_nomina_ult1))
sum(is.na(san.train.samp$ind_nomina_ult1))
# 1609
# fill in missing values for products by looking at previous months
san.train.samp[ 377559,]
san.train.samp[san.train.samp$ncodpers== 716415,]
# but previous months are also NA
# just make them zero then
# luckily not a large group

san.train.samp[is.na(san.train.samp$ind_nomina_ult1)]=0
#warnings()
sum(is.na(san.train.samp$ind_nomina_ult1)) #0
san.train.samp$ind_nomina_ult1[ind_nomina.mis]

# done here
```


```{r}
############################ 11. Missing Values: "ind_nom_pens_ult1" ########################
mis.name[11]
# "ind_nom_pens_ult1"
# Pensions
sum(is.na(san.train.samp$ind_nom_pens_ult1))
# 0
#? how so 
# before setting up payroll=0, it was 1609
san.train.samp$ind_nom_pens_ult1[ind_nomina.mis]
san.train.samp[is.na(san.train.samp$ind_nom_pens_ult1)]=0
san.train.samp$ind_nom_pens_ult1[ind_nomina.mis]
# looks like ind_nomina_ult1 and ind_nom_pens_ult1 are dependent!!!
```


```{r}
# See if there is any missing values left
# which columns have missing values?
which(sapply(san.train.samp,function(x) any(is.na(x))) == TRUE)
# all good
```


```{r}
# save Rdata
save(san.train.samp,file = "san.train.samp(cleaned).RData")
```

